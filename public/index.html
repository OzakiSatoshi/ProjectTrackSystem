<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>案件管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .actions {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .anken-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .anken-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .anken-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .anken-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .anken-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            line-height: 1.3;
        }
        
        .anken-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 16px;
            margin-bottom: 16px;
        }
        
        .anken-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .anken-info-label {
            font-size: 11px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .anken-info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .anken-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .anken-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            background: #f0f2f5;
            color: #5a6c7d;
        }
        
        .anken-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        
        .anken-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .table-container {
            display: none;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-1 { background: #e3f2fd; color: #1976d2; }
        .status-2 { background: #e8f5e8; color: #388e3c; }
        .status-3 { background: #f3e5f5; color: #7b1fa2; }
        .status-4 { background: #fff3e0; color: #f57c00; }
        
        .telework-status {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        
        tr:hover td {
            background: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .anken-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }
            
            .anken-card {
                padding: 16px;
            }
            
            .anken-title {
                font-size: 16px;
            }
            
            .anken-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
            
            /* Mobile search filters - stack vertically */
            .card div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>案件管理システム</h1>
            <p>プロジェクト、連絡先、および取引先の管理</p>
        </header>
        
        <div class="actions">
            <button onclick="showSection('anken')">案件一覧</button>
            <button onclick="showSection('contacts')" class="secondary">担当者一覧</button>
            <button onclick="showSection('accounts')" class="secondary">取引先一覧</button>
            <button onclick="openModal('ankenModal')" class="secondary">新規案件作成</button>
            <button onclick="loadData()" class="secondary">更新</button>
        </div>
        
        <!-- Anken Section -->
        <div id="ankenSection" class="section">
            <!-- Search and Filter Panel -->
        <div class="card" style="margin-bottom: 20px;">
            <div style="padding: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #2c3e50;">検索・フィルター</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="searchText">案件名・詳細</label>
                        <input type="text" id="searchText" placeholder="キーワードで検索..." onInput="applyFilters()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterLocation">勤務地</label>
                        <input type="text" id="filterLocation" placeholder="勤務地で検索..." onInput="applyFilters()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterKen">都道府県</label>
                        <select id="filterKen" onchange="applyFilters()">
                            <option value="">すべて</option>
                            <option value="東京都">東京都</option>
                            <option value="大阪府">大阪府</option>
                            <option value="愛知県">愛知県</option>
                            <option value="福岡県">福岡県</option>
                            <option value="リモート">リモート</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterProgram">プログラム言語</label>
                        <input type="text" id="filterProgram" placeholder="Java, Python..." onInput="applyFilters()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterPlatform">プラットフォーム</label>
                        <input type="text" id="filterPlatform" placeholder="Web, Mobile..." onInput="applyFilters()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterProcess">工程</label>
                        <input type="text" id="filterProcess" placeholder="設計, 開発..." onInput="applyFilters()">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterTelework">テレワーク <small style="color: #999; font-size: 10px;">(〇:フル △:部分 ✕:常駐)</small></label>
                        <select id="filterTelework" onchange="applyFilters()">
                            <option value="">すべて</option>
                            <option value="full">〇</option>
                            <option value="partial">△</option>
                            <option value="none">✕</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="clearFilters()" class="secondary" style="padding: 8px 16px;">フィルタークリア</button>
                    <span id="resultCount" style="color: #666; font-size: 14px;"></span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div id="ankenGrid" class="anken-grid">
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                    読み込み中...
                </div>
            </div>
        </div>
        </div>

        <!-- Contacts Section -->
        <div id="contactsSection" class="section" style="display: none;">
            <div class="card" style="margin-bottom: 20px;">
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50;">担当者一覧</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="contactSearchText">氏名・役職</label>
                            <input type="text" id="contactSearchText" placeholder="キーワードで検索..." onInput="applyContactFilters()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="contactAccountFilter">取引先</label>
                            <select id="contactAccountFilter" onchange="applyContactFilters()">
                                <option value="">すべて</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="openModal('contactModal')" class="secondary">担当者追加</button>
                    </div>
                </div>
            </div>
            <div id="contactsGrid" class="anken-grid">
                <!-- Contacts will be loaded here -->
            </div>
        </div>

        <!-- Accounts Section -->
        <div id="accountsSection" class="section" style="display: none;">
            <div class="card" style="margin-bottom: 20px;">
                <div style="padding: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50;">取引先一覧</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="accountSearchText">会社名・業界</label>
                            <input type="text" id="accountSearchText" placeholder="キーワードで検索..." onInput="applyAccountFilters()">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="industryFilter">業界</label>
                            <select id="industryFilter" onchange="applyAccountFilters()">
                                <option value="">すべて</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="openModal('accountModal')" class="secondary">取引先追加</button>
                    </div>
                </div>
            </div>
            <div id="accountsGrid" class="anken-grid">
                <!-- Accounts will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Anken Modal -->
    <div id="ankenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ankenModalTitle">案件作成</h3>
                <span class="close" onclick="closeModal('ankenModal')">&times;</span>
            </div>
            <form id="ankenForm">
                <div class="form-group">
                    <label for="anken_name">案件名 *</label>
                    <input type="text" id="anken_name" required>
                </div>
                <div class="form-group">
                    <label for="contact_id">担当者</label>
                    <select id="contact_id">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="detail">詳細</label>
                    <textarea id="detail" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="notes">備考</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">期間・価格</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="start_date">開始日</label>
                        <input type="date" id="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">終了日</label>
                        <input type="date" id="end_date">
                    </div>
                    <div class="form-group">
                        <label for="limit_date">締切日</label>
                        <input type="date" id="limit_date">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="price">価格</label>
                        <input type="text" id="price" placeholder="¥1,000,000">
                    </div>
                    <div class="form-group">
                        <label for="contract">契約形態</label>
                        <input type="text" id="contract" placeholder="準委任、請負等">
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">技術要件</h4>
                <div class="form-group">
                    <label for="required_skills">必須スキル</label>
                    <textarea id="required_skills" rows="2" placeholder="Java, Spring Boot, AWS等"></textarea>
                </div>
                <div class="form-group">
                    <label for="nice_skills">歓迎スキル</label>
                    <textarea id="nice_skills" rows="2" placeholder="Docker, Kubernetes等"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="process">工程</label>
                        <input type="text" id="process" placeholder="要件定義、設計、開発">
                    </div>
                    <div class="form-group">
                        <label for="program">プログラム言語</label>
                        <input type="text" id="program" placeholder="Java, Python, JavaScript">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="platform">プラットフォーム</label>
                        <input type="text" id="platform" placeholder="AWS, Azure, GCP">
                    </div>
                    <div class="form-group">
                        <label for="framework">フレームワーク</label>
                        <input type="text" id="framework" placeholder="Spring, React, Vue">
                    </div>
                    <div class="form-group">
                        <label for="db">データベース</label>
                        <input type="text" id="db" placeholder="MySQL, PostgreSQL, Oracle">
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">勤務条件</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="location">勤務地</label>
                        <input type="text" id="location" placeholder="東京都渋谷区、大阪府大阪市等">
                    </div>
                    <div class="form-group">
                        <label for="ken">都道府県</label>
                        <input type="text" id="ken" placeholder="東京都、大阪府等">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="time_from">開始時間</label>
                        <input type="time" id="time_from">
                    </div>
                    <div class="form-group">
                        <label for="time_to">終了時間</label>
                        <input type="time" id="time_to">
                    </div>
                    <div class="form-group">
                        <label for="telework_yn">テレワーク <small style="color: #999; font-size: 10px;">(〇:フル △:部分 ✕:常駐)</small></label>
                        <select id="telework_yn">
                            <option value="">選択</option>
                            <option value="0">✕</option>
                            <option value="1">△</option>
                            <option value="2">〇</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="persons">人数</label>
                        <input type="text" id="persons" placeholder="2名、3-5名等">
                    </div>
                    <div class="form-group">
                        <label for="foreigner">外国人可否</label>
                        <select id="foreigner">
                            <option value="">選択</option>
                            <option value="可">可</option>
                            <option value="不可">不可</option>
                            <option value="要相談">要相談</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="telework">テレワーク詳細</label>
                        <input type="text" id="telework" placeholder="週2-3日在宅等">
                    </div>
                </div>

                
                <div class="form-actions">
                    <button type="button" onclick="closeModal('ankenModal')" class="secondary">キャンセル</button>
                    <button type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>連絡先追加</h3>
                <span class="close" onclick="closeModal('contactModal')">&times;</span>
            </div>
            <form id="contactForm">
                <div class="form-group">
                    <label for="account_id">取引先 *</label>
                    <select id="account_id" required>
                        <option value="">選択してください</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="contact_name">連絡先名 *</label>
                    <input type="text" id="contact_name" required placeholder="山田 太郎">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="lastname">姓</label>
                        <input type="text" id="lastname" placeholder="山田" onInput="updateContactName()">
                    </div>
                    <div class="form-group">
                        <label for="firstname">名</label>
                        <input type="text" id="firstname" placeholder="太郎" onInput="updateContactName()">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobtitle">役職</label>
                        <input type="text" id="jobtitle" placeholder="営業部長">
                    </div>
                    <div class="form-group">
                        <label for="department">部署</label>
                        <input type="text" id="department" placeholder="営業部">
                    </div>
                </div>
                

                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="telephone1">電話番号</label>
                        <input type="text" id="telephone1" placeholder="03-1234-5678">
                    </div>
                    <div class="form-group">
                        <label for="mobilephone">携帯電話</label>
                        <input type="text" id="mobilephone" placeholder="090-1234-5678">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email_address1">メールアドレス</label>
                    <input type="email" id="email_address1" placeholder="yamada@company.com">
                </div>
                
                <div class="form-group">
                    <label for="address1_line1">住所</label>
                    <input type="text" id="address1_line1" placeholder="東京都渋谷区...">
                </div>
                
                <div class="form-group">
                    <label for="description">備考</label>
                    <textarea id="description" rows="2" placeholder="追加情報"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeModal('contactModal')" class="secondary">キャンセル</button>
                    <button type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>取引先追加</h3>
                <span class="close" onclick="closeModal('accountModal')">&times;</span>
            </div>
            <form id="accountForm">
                <div class="form-group">
                    <label for="account_name">取引先名 *</label>
                    <input type="text" id="account_name" required>
                </div>
                <div class="form-group">
                    <label for="account_number">取引先番号</label>
                    <input type="text" id="account_number">
                </div>
                <div class="form-group">
                    <label for="telephone1">電話番号</label>
                    <input type="text" id="telephone1" placeholder="03-1234-5678">
                </div>
                <div class="form-group">
                    <label for="website_url">Webサイト</label>
                    <input type="url" id="website_url" placeholder="https://www.company.com">
                </div>
                <div class="form-group">
                    <label for="address1_line1">住所</label>
                    <input type="text" id="address1_line1" placeholder="東京都渋谷区...">
                </div>
                <div class="form-group">
                    <label for="industry_code">業界</label>
                    <input type="text" id="industry_code" placeholder="IT・ソフトウェア">
                </div>
                <div class="form-group">
                    <label for="description">説明</label>
                    <textarea id="description" rows="3" placeholder="取引先の詳細情報"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('accountModal')" class="secondary">キャンセル</button>
                    <button type="submit">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>案件詳細</h3>
                <span class="close" onclick="closeModal('detailsModal')">&times;</span>
            </div>
            <div id="detailsContent">
                <!-- Details will be populated here -->
            </div>
            <div class="form-actions">
                <button onclick="closeModal('detailsModal')" class="secondary">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        let currentAnkenId = null;
        let allAnken = []; // Store all anken data for filtering
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('ankenForm').addEventListener('submit', handleAnkenSubmit);
            document.getElementById('contactForm').addEventListener('submit', handleContactSubmit);
            document.getElementById('accountForm').addEventListener('submit', handleAccountSubmit);
        }
        
        function showSection(sectionName) {
            // Hide all sections
            const ankenSection = document.getElementById('ankenSection');
            const contactsSection = document.getElementById('contactsSection');
            const accountsSection = document.getElementById('accountsSection');
            
            if (ankenSection) ankenSection.style.display = 'none';
            if (contactsSection) contactsSection.style.display = 'none';
            if (accountsSection) accountsSection.style.display = 'none';
            
            // Show selected section
            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                
                // Load data for the section
                if (sectionName === 'anken') {
                    loadAnken();
                } else if (sectionName === 'contacts') {
                    loadContactsList();
                } else if (sectionName === 'accounts') {
                    loadAccountsList();
                }
            }
        }

        async function loadData() {
            await Promise.all([
                loadAnken(),
                loadAccounts(),
                loadContacts()
            ]);
        }
        
        async function loadAnken() {
            try {
                const response = await fetch('/api/anken');
                allAnken = await response.json();
                applyFilters();
            } catch (error) {
                console.error('Error loading anken:', error);
                document.getElementById('ankenGrid').innerHTML = 
                    '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #e74c3c;">データの読み込みに失敗しました</div>';
            }
        }
        
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();
                populateAccountSelect(accounts);
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        async function loadContacts() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                populateContactSelect(contacts);
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }
        
        function renderAnkenCards(anken) {
            const grid = document.getElementById('ankenGrid');
            
            if (anken.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">案件がありません</div>';
                return;
            }
            
            grid.innerHTML = anken.map(item => `
                <div class="anken-card" onclick="viewAnkenDetails('${item.anken_id}')">
                    <div class="anken-header">
                        <h3 class="anken-title">${item.anken_name || '無題'}</h3>
                    </div>
                    
                    <div class="anken-info">
                        <div class="anken-info-item">
                            <span class="anken-info-label">連絡先</span>
                            <span class="anken-info-value">${item.contact_name || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">取引先</span>
                            <span class="anken-info-value">${item.account_name || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">作業場所</span>
                            <span class="anken-info-value">${item.location || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">価格</span>
                            <span class="anken-info-value">${item.price || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">期間</span>
                            <span class="anken-info-value">${item.start_date || '-'} ～ ${item.end_date || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">テレワーク <small style="color: #999; font-size: 9px;">(〇:フル △:部分 ✕:常駐)</small></span>
                            <span class="anken-info-value">${getTeleworkDisplay(item.telework_yn)}</span>
                        </div>
                    </div>
                    
                    <div class="anken-tags">
                        ${item.process ? `<span class="anken-tag">📋 ${item.process}</span>` : ''}
                        ${item.program ? `<span class="anken-tag">💻 ${item.program}</span>` : ''}
                        ${item.platform ? `<span class="anken-tag">📱 ${item.platform}</span>` : ''}
                        ${item.framework ? `<span class="anken-tag">🔧 ${item.framework}</span>` : ''}
                    </div>
                    
                    <div class="anken-actions" onclick="event.stopPropagation();">
                        <button onclick="editAnken('${item.anken_id}')" class="secondary">編集</button>
                        <button onclick="deleteAnken('${item.anken_id}')" class="danger">削除</button>
                    </div>
                </div>
            `).join('');
        }
        
        function populateAccountSelect(accounts) {
            const select = document.getElementById('account_id');
            select.innerHTML = '<option value="">選択してください</option>' +
                accounts.map(account => 
                    `<option value="${account.account_id}">${account.account_name}</option>`
                ).join('');
                
            // Also populate industry filter for accounts section
            const industryFilter = document.getElementById('industryFilter');
            if (industryFilter) {
                industryFilter.innerHTML = '<option value="">すべて</option>';
                const uniqueIndustries = [...new Set(accounts.map(a => a.industry_code).filter(Boolean))];
                uniqueIndustries.forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry;
                    option.textContent = industry;
                    industryFilter.appendChild(option);
                });
            }
            
            // Populate contact account filter
            const contactAccountFilter = document.getElementById('contactAccountFilter');
            if (contactAccountFilter) {
                contactAccountFilter.innerHTML = '<option value="">すべて</option>';
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.account_name;
                    option.textContent = account.account_name;
                    contactAccountFilter.appendChild(option);
                });
            }
        }
        
        function populateContactSelect(contacts) {
            const select = document.getElementById('contact_id');
            select.innerHTML = '<option value="">選択してください</option>' +
                contacts.map(contact => 
                    `<option value="${contact.contact_id}">${contact.contact_name} (${contact.account?.account_name || '所属なし'})</option>`
                ).join('');
        }

        async function loadContactsList() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                displayContacts(contacts);
            } catch (error) {
                console.error('Error loading contacts list:', error);
                const contactsGrid = document.getElementById('contactsGrid');
                if (contactsGrid) {
                    contactsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">担当者の読み込みに失敗しました</div>';
                }
            }
        }

        function displayContacts(contacts) {
            const grid = document.getElementById('contactsGrid');
            if (!grid) return;
            
            if (contacts.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">担当者がありません</div>';
                return;
            }
            
            grid.innerHTML = contacts.map(contact => `
                <div class="anken-card">
                    <div class="anken-header">
                        <h3 class="anken-title">${contact.contact_name || '-'}</h3>
                    </div>
                    <div class="anken-info">
                        <div class="anken-info-item">
                            <span class="anken-info-label">取引先</span>
                            <span class="anken-info-value">${contact.account?.account_name || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">役職</span>
                            <span class="anken-info-value">${contact.jobtitle || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">部署</span>
                            <span class="anken-info-value">${contact.department || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">電話</span>
                            <span class="anken-info-value">${contact.telephone1 || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">メール</span>
                            <span class="anken-info-value">${contact.email_address1 || '-'}</span>
                        </div>
                    </div>
                    <div class="anken-actions">
                        <button onclick="editContact('${contact.contact_id}')" class="secondary">編集</button>
                        <button onclick="deleteContact('${contact.contact_id}')" class="danger">削除</button>
                    </div>
                </div>
            `).join('');
        }

        function applyContactFilters() {
            const searchText = document.getElementById('contactSearchText')?.value.toLowerCase() || '';
            const accountFilter = document.getElementById('contactAccountFilter')?.value || '';
            
            // Get contacts data and filter
            fetch('/api/contacts')
                .then(response => response.json())
                .then(allContacts => {
                    const filtered = allContacts.filter(contact => {
                        const matchesSearch = !searchText || 
                            (contact.contact_name && contact.contact_name.toLowerCase().includes(searchText)) ||
                            (contact.jobtitle && contact.jobtitle.toLowerCase().includes(searchText)) ||
                            (contact.department && contact.department.toLowerCase().includes(searchText));
                        
                        const matchesAccount = !accountFilter || (contact.account && contact.account.account_name === accountFilter);
                        
                        return matchesSearch && matchesAccount;
                    });
                    
                    displayContacts(filtered);
                })
                .catch(error => console.error('Error filtering contacts:', error));
        }

        async function loadAccountsList() {
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();
                displayAccounts(accounts);
            } catch (error) {
                console.error('Error loading accounts list:', error);
                const accountsGrid = document.getElementById('accountsGrid');
                if (accountsGrid) {
                    accountsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">取引先の読み込みに失敗しました</div>';
                }
            }
        }

        function displayAccounts(accounts) {
            const grid = document.getElementById('accountsGrid');
            if (!grid) return;
            
            if (accounts.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">取引先がありません</div>';
                return;
            }
            
            grid.innerHTML = accounts.map(account => `
                <div class="anken-card">
                    <div class="anken-header">
                        <h3 class="anken-title">${account.account_name || '-'}</h3>
                    </div>
                    <div class="anken-info">
                        <div class="anken-info-item">
                            <span class="anken-info-label">業界</span>
                            <span class="anken-info-value">${account.industry_code || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">電話</span>
                            <span class="anken-info-value">${account.telephone1 || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">住所</span>
                            <span class="anken-info-value">${account.address1_line1 || '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">ウェブサイト</span>
                            <span class="anken-info-value">${account.website_url ? `<a href="${account.website_url}" target="_blank">${account.website_url}</a>` : '-'}</span>
                        </div>
                        <div class="anken-info-item">
                            <span class="anken-info-label">説明</span>
                            <span class="anken-info-value">${account.description || '-'}</span>
                        </div>
                    </div>
                    <div class="anken-actions">
                        <button onclick="editAccount('${account.account_id}')" class="secondary">編集</button>
                        <button onclick="deleteAccount('${account.account_id}')" class="danger">削除</button>
                    </div>
                </div>
            `).join('');
        }

        function applyAccountFilters() {
            const searchText = document.getElementById('accountSearchText')?.value.toLowerCase() || '';
            const industryFilter = document.getElementById('industryFilter')?.value || '';
            
            // Get accounts data and filter
            fetch('/api/accounts')
                .then(response => response.json())
                .then(allAccounts => {
                    const filtered = allAccounts.filter(account => {
                        const matchesSearch = !searchText || 
                            (account.account_name && account.account_name.toLowerCase().includes(searchText)) ||
                            (account.industry_code && account.industry_code.toLowerCase().includes(searchText)) ||
                            (account.description && account.description.toLowerCase().includes(searchText));
                        
                        const matchesIndustry = !industryFilter || account.industry_code === industryFilter;
                        
                        return matchesSearch && matchesIndustry;
                    });
                    
                    displayAccounts(filtered);
                })
                .catch(error => console.error('Error filtering accounts:', error));
        }
        
        function getTeleworkDisplay(teleworkYn) {
            switch(teleworkYn) {
                case 2: return '〇';
                case 1: return '△';
                case 0: return '✕';
                default: return '-';
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'ankenModal') {
                currentAnkenId = null;
                document.getElementById('ankenModalTitle').textContent = '案件作成';
                document.getElementById('ankenForm').reset();
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function updateContactName() {
            const lastname = document.getElementById('lastname').value;
            const firstname = document.getElementById('firstname').value;
            
            if (lastname && firstname) {
                const contactName = `${lastname} ${firstname}`;
                document.getElementById('contact_name').value = contactName;
            }
        }
        
        async function handleAnkenSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                anken_name: document.getElementById('anken_name').value,
                contact_id: document.getElementById('contact_id').value || null,
                detail: document.getElementById('detail').value,

                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                price: document.getElementById('price').value,
                process: document.getElementById('process').value,
                program: document.getElementById('program').value
            };
            
            try {
                const url = currentAnkenId ? `/api/anken/${currentAnkenId}` : '/api/anken';
                const method = currentAnkenId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('ankenModal');
                    loadAnken(); // This will reload and reapply filters
                } else {
                    alert('保存に失敗しました');
                }
            } catch (error) {
                console.error('Error saving anken:', error);
                alert('保存に失敗しました');
            }
        }
        
        async function handleContactSubmit(e) {
            e.preventDefault();
            
            // Auto-generate contact_name from lastname + firstname if both are provided
            const lastname = document.getElementById('lastname').value;
            const firstname = document.getElementById('firstname').value;
            let contactName = document.getElementById('contact_name').value;
            
            if (lastname && firstname) {
                contactName = `${lastname} ${firstname}`;
                document.getElementById('contact_name').value = contactName;
            }
            
            const data = {
                contact_name: contactName,
                account_id: document.getElementById('account_id').value,
                firstname: firstname,
                lastname: lastname,
                fullname: contactName,
                jobtitle: document.getElementById('jobtitle').value,
                department: document.getElementById('department').value,
                telephone1: document.getElementById('telephone1').value,
                mobilephone: document.getElementById('mobilephone').value,
                email_address1: document.getElementById('email_address1').value,
                address1_line1: document.getElementById('address1_line1').value,
                description: document.getElementById('description').value
            };
            
            try {
                const response = await fetch('/api/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show warning if duplicate name detected
                    if (result.warning) {
                        if (confirm(`${result.warning}\n\n登録を続行しますか？`)) {
                            closeModal('contactModal');
                            document.getElementById('contactForm').reset();
                            loadContacts();
                            const contactsSection = document.getElementById('contactsSection');
                            if (contactsSection && contactsSection.style.display !== 'none') {
                                loadContactsList(); // Refresh contacts list if visible
                            }
                        }
                    } else {
                        closeModal('contactModal');
                        document.getElementById('contactForm').reset();
                        loadContacts();
                        const contactsSection = document.getElementById('contactsSection');
                        if (contactsSection && contactsSection.style.display !== 'none') {
                            loadContactsList(); // Refresh contacts list if visible
                        }
                    }
                } else {
                    alert('保存に失敗しました');
                }
            } catch (error) {
                console.error('Error saving contact:', error);
                alert('保存に失敗しました');
            }
        }
        
        async function handleAccountSubmit(e) {
            e.preventDefault();
            
            const data = {
                account_name: document.getElementById('account_name').value
            };
            
            try {
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal('accountModal');
                    document.getElementById('accountForm').reset();
                    loadAccounts();
                } else {
                    alert('保存に失敗しました');
                }
            } catch (error) {
                console.error('Error saving account:', error);
                alert('保存に失敗しました');
            }
        }
        
        async function editAnken(ankenId) {
            try {
                const response = await fetch(`/api/anken/${ankenId}`);
                const anken = await response.json();
                
                currentAnkenId = ankenId;
                document.getElementById('ankenModalTitle').textContent = '案件編集';
                
                // Populate form
                document.getElementById('anken_name').value = anken.anken_name || '';
                document.getElementById('contact_id').value = anken.contact_id || '';
                document.getElementById('detail').value = anken.detail || '';

                document.getElementById('start_date').value = anken.start_date || '';
                document.getElementById('end_date').value = anken.end_date || '';
                document.getElementById('price').value = anken.price || '';
                document.getElementById('process').value = anken.process || '';
                document.getElementById('program').value = anken.program || '';
                
                openModal('ankenModal');
            } catch (error) {
                console.error('Error loading anken for edit:', error);
                alert('案件の読み込みに失敗しました');
            }
        }

        async function editContact(contactId) {
            // Implementation for editing contacts
            console.log('Edit contact:', contactId);
        }

        async function deleteContact(contactId) {
            if (!confirm('この担当者を削除しますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadContacts();
                    const contactsSection = document.getElementById('contactsSection');
                    if (contactsSection && contactsSection.style.display !== 'none') {
                        loadContactsList();
                    }
                } else {
                    alert('削除に失敗しました');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                alert('削除に失敗しました');
            }
        }

        async function editAccount(accountId) {
            // Implementation for editing accounts
            console.log('Edit account:', accountId);
        }

        async function deleteAccount(accountId) {
            if (!confirm('この取引先を削除しますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadAccounts();
                    const accountsSection = document.getElementById('accountsSection');
                    if (accountsSection && accountsSection.style.display !== 'none') {
                        loadAccountsList();
                    }
                } else {
                    alert('削除に失敗しました');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('削除に失敗しました');
            }
        }
        
        async function deleteAnken(ankenId) {
            if (!confirm('この案件を削除しますか？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/anken/${ankenId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadAnken(); // This will reload and reapply filters
                } else {
                    alert('削除に失敗しました');
                }
            } catch (error) {
                console.error('Error deleting anken:', error);
                alert('削除に失敗しました');
            }
        }
        
        async function viewAnkenDetails(ankenId) {
            try {
                const response = await fetch(`/api/anken/${ankenId}`);
                const anken = await response.json();
                
                const detailsContent = document.getElementById('detailsContent');
                detailsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">基本情報</h4>
                            <div style="margin-bottom: 10px;"><strong>案件名:</strong> ${anken.anken_name || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>連絡先:</strong> ${anken.contact_name || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>取引先:</strong> ${anken.account_name || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>価格:</strong> ${anken.price || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>契約形態:</strong> ${anken.contract || '-'}</div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">期間</h4>
                            <div style="margin-bottom: 10px;"><strong>開始日:</strong> ${anken.start_date || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>終了日:</strong> ${anken.end_date || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>締切日:</strong> ${anken.limit_date || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>勤務時間:</strong> ${anken.time_from || '-'} ~ ${anken.time_to || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>人数:</strong> ${anken.persons || '-'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">技術要件</h4>
                            <div style="margin-bottom: 10px;"><strong>工程:</strong> ${anken.process || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>プログラム言語:</strong> ${anken.program || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>プラットフォーム:</strong> ${anken.platform || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>フレームワーク:</strong> ${anken.framework || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>データベース:</strong> ${anken.db || '-'}</div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">勤務条件</h4>
                            <div style="margin-bottom: 10px;"><strong>勤務地:</strong> ${anken.location || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>都道府県:</strong> ${anken.ken || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>テレワーク:</strong> 
                                ${getTeleworkDisplay(anken.telework_yn)} <small style="color: #999; font-size: 10px;">(〇:フル △:部分 ✕:常駐)</small>
                            </div>
                            <div style="margin-bottom: 10px;"><strong>テレワーク詳細:</strong> ${anken.telework || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>外国人可否:</strong> ${anken.foreigner || '-'}</div>
                        </div>
                    </div>
                    
                    ${anken.required_skills ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">必須スキル</h4>
                            <p style="line-height: 1.6; color: #666;">${anken.required_skills}</p>
                        </div>
                    ` : ''}
                    
                    ${anken.nice_skills ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">歓迎スキル</h4>
                            <p style="line-height: 1.6; color: #666;">${anken.nice_skills}</p>
                        </div>
                    ` : ''}
                    
                    ${anken.detail ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">詳細説明</h4>
                            <p style="line-height: 1.6; color: #666;">${anken.detail}</p>
                        </div>
                    ` : ''}
                    
                    ${anken.notes ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">備考</h4>
                            <p style="line-height: 1.6; color: #666;">${anken.notes}</p>
                        </div>
                    ` : ''}
                    

                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">技術要件</h4>
                            <div style="margin-bottom: 10px;"><strong>必須スキル:</strong> ${anken.required_skills || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>歓迎スキル:</strong> ${anken.nice_skills || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>プラットフォーム:</strong> ${anken.platform || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>フレームワーク:</strong> ${anken.framework || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>データベース:</strong> ${anken.db || '-'}</div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">勤務条件</h4>
                            <div style="margin-bottom: 10px;"><strong>場所:</strong> ${anken.location || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>都道府県:</strong> ${anken.ken || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>勤務時間:</strong> 
                                ${anken.time_from && anken.time_to ? `${anken.time_from} - ${anken.time_to}` : '-'}
                            </div>
                            <div style="margin-bottom: 10px;"><strong>契約:</strong> ${anken.contract || '-'}</div>
                        </div>
                    </div>
                    
                    ${anken.notes ? `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">備考</h4>
                            <p style="line-height: 1.6; color: #666;">${anken.notes}</p>
                        </div>
                    ` : ''}
                `;
                
                openModal('detailsModal');
            } catch (error) {
                console.error('Error loading anken details:', error);
                alert('案件詳細の読み込みに失敗しました');
            }
        }
        
        function applyFilters() {
            const searchText = document.getElementById('searchText').value.toLowerCase();
            const filterLocation = document.getElementById('filterLocation').value.toLowerCase();
            const filterKen = document.getElementById('filterKen').value;
            const filterProgram = document.getElementById('filterProgram').value.toLowerCase();
            const filterPlatform = document.getElementById('filterPlatform').value.toLowerCase();
            const filterProcess = document.getElementById('filterProcess').value.toLowerCase();

            const filterTelework = document.getElementById('filterTelework').value;
            
            const filteredAnken = allAnken.filter(item => {
                // Text search in name and detail
                const textMatch = !searchText || 
                    (item.anken_name && item.anken_name.toLowerCase().includes(searchText)) ||
                    (item.detail && item.detail.toLowerCase().includes(searchText));
                
                // Location filter
                const locationMatch = !filterLocation || 
                    (item.location && item.location.toLowerCase().includes(filterLocation));
                
                // Prefecture filter
                const kenMatch = !filterKen || item.ken === filterKen;
                
                // Programming language filter
                const programMatch = !filterProgram || 
                    (item.program && item.program.toLowerCase().includes(filterProgram));
                
                // Platform filter
                const platformMatch = !filterPlatform || 
                    (item.platform && item.platform.toLowerCase().includes(filterPlatform));
                
                // Process filter
                const processMatch = !filterProcess || 
                    (item.process && item.process.toLowerCase().includes(filterProcess));
                
                // Telework filter
                const teleworkMatch = !filterTelework || 
                    (filterTelework === 'full' && item.telework_yn === 2) ||
                    (filterTelework === 'partial' && item.telework_yn === 1) ||
                    (filterTelework === 'none' && item.telework_yn === 0);
                
                return textMatch && locationMatch && kenMatch && programMatch && 
                       platformMatch && processMatch && teleworkMatch;
            });
            
            renderAnkenCards(filteredAnken);
            updateResultCount(filteredAnken.length, allAnken.length);
        }
        
        function clearFilters() {
            document.getElementById('searchText').value = '';
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterKen').value = '';
            document.getElementById('filterProgram').value = '';
            document.getElementById('filterPlatform').value = '';
            document.getElementById('filterProcess').value = '';
            document.getElementById('filterTelework').value = '';
            applyFilters();
        }
        
        function updateResultCount(filtered, total) {
            const resultCount = document.getElementById('resultCount');
            if (filtered === total) {
                resultCount.textContent = `${total}件の案件`;
            } else {
                resultCount.textContent = `${filtered}件表示 / 全${total}件`;
            }
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>